<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For My Love üíñ | Our Special Space</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #ffafbd, #ffc3a0, #a6c1ee, #fbc2eb);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        .header {
            text-align: center;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,105,180,0.1) 0%, transparent 70%);
            animation: float 8s linear infinite;
        }

        @keyframes float {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .main-title {
            font-family: 'Dancing Script', cursive;
            font-size: 4rem;
            color: #ff4081;
            margin-bottom: 10px;
            text-shadow: 3px 3px 0px rgba(255, 105, 180, 0.2);
            position: relative;
            z-index: 1;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 30px;
        }

        .heart-pulse {
            font-size: 3rem;
            color: #ff4081;
            animation: pulse 1.5s infinite;
            margin: 20px 0;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Love Messages Section */
        .love-messages {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-family: 'Dancing Script', cursive;
            font-size: 2.5rem;
            color: #ff4081;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(to right, #ff4081, #ff8e53);
            border-radius: 2px;
        }

        /* Message Cards */
        .messages-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .message-card {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border-left: 5px solid #ff4081;
        }

        .message-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 15px 30px rgba(255, 64, 129, 0.2);
        }

        .message-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, #ff4081, #ff8e53);
        }

        .message-content {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #555;
            margin-bottom: 15px;
        }

        .message-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #888;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .love-icon {
            color: #ff4081;
            margin-right: 5px;
        }

        /* Write Message Section */
        .write-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .message-form {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            color: #ff4081;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .message-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            resize: vertical;
            min-height: 150px;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: #ff4081;
            box-shadow: 0 0 0 3px rgba(255, 64, 129, 0.1);
        }

        .submit-btn {
            background: linear-gradient(45deg, #ff4081, #ff8e53);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto 0;
            position: relative;
            overflow: hidden;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 64, 129, 0.3);
        }

        .submit-btn:active {
            transform: translateY(-1px);
        }

        .submit-btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(45deg);
            transition: all 0.5s ease;
        }

        .submit-btn:hover::after {
            transform: rotate(45deg) translate(50%, 50%);
        }

        /* Memories Section */
        .memories-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .memory-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffafbd, #ffc3a0);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Special Effects */
        .floating-hearts {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .heart {
            position: absolute;
            color: rgba(255, 64, 129, 0.3);
            font-size: 20px;
            animation: floatUp 15s linear infinite;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        /* Loading Animation */
        .loader {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #ff4081;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px;
            color: white;
            margin-top: 50px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
        }

        .footer-heart {
            color: #ff4081;
            animation: heartbeat 1.5s infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-title {
                font-size: 2.5rem;
            }
            
            .section-title {
                font-size: 2rem;
            }
            
            .messages-container {
                grid-template-columns: 1fr;
            }
            
            .memory-stats {
                grid-template-columns: 1fr;
            }
            
            .write-section, .memories-section {
                padding: 20px;
            }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        /* Love Timer */
        .love-timer {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .timer-display {
            font-family: monospace;
            font-size: 1.5rem;
            color: #ff4081;
            margin: 10px 0;
        }

        /* Secret Message */
        .secret-message {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }

        /* Typewriter Effect */
        .typewriter {
            overflow: hidden;
            border-right: .15em solid #ff4081;
            white-space: nowrap;
            margin: 0 auto;
            letter-spacing: .15em;
            animation: typing 3.5s steps(40, end), blink-caret .75s step-end infinite;
        }

        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: #ff4081; }
        }

        /* Love Quote */
        .love-quote {
            font-style: italic;
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            color: #666;
            border-left: 3px solid #ff4081;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 0 10px 10px 0;
        }

        /* Music Player */
        .music-player {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 50px;
            padding: 10px 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 100;
        }

        .music-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #ff4081;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .music-btn:hover {
            transform: scale(1.2);
        }
        
        /* Error Message */
        .error-message {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Floating Hearts Background -->
    <div class="floating-hearts" id="heartsContainer"></div>

<!-- Music Player -->
<div class="music-player" id="musicPlayer">
    <button class="music-btn" onclick="previousSong()">
        <i class="fas fa-step-backward"></i>
    </button>
    <button class="music-btn" onclick="toggleMusic()" id="musicBtn">
        <i class="fas fa-play"></i>
    </button>
    <button class="music-btn" onclick="nextSong()">
        <i class="fas fa-step-forward"></i>
    </button>
    <span style="margin-left: 10px; color: #666; font-size: 0.9rem;" id="songTitle">
        Duniya ‚ù§Ô∏è
    </span>
</div>
<audio id="bgMusic"></audio>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="heart-pulse">
                <i class="fas fa-heart"></i>
            </div>
            <h1 class="main-title typewriter">For My Beautiful Love üíñ</h1>
            <p class="subtitle">A special space where our hearts connect forever...</p>
            
            <!-- Love Timer -->
          <div class="love-timer">
    <p style="color: #ff4081; font-weight: 600; margin-bottom: 10px;">
        <i class="fas fa-heart"></i> Our Love Journey <i class="fas fa-heart"></i>
    </p>
    <div class="timer-display" id="loveTimer">0 days, 00:00:00</div>
    <p style="margin-top: 10px; color: #666;">
        Since that beautiful day: <span style="color: #ff4081; font-weight: 600;">4th June 2024</span>
    </p>
    <p style="color: #888; font-size: 0.8rem; margin-top: 5px;">
        Every second with you is precious üíï
    </p>
</div>
        </header>

        <!-- Error Message (If any) -->
        <div class="error-message" id="errorMessage"></div>

        <!-- Secret Message (Will appear randomly) -->
        <div class="secret-message" id="secretMessage">
            <h3><i class="fas fa-star love-icon"></i> Secret Message For You! <i class="fas fa-star love-icon"></i></h3>
            <p id="secretText"></p>
        </div>

        <!-- Love Quote -->
        <div class="love-quote" id="loveQuote">
            "You are the source of my joy, the center of my world, and the whole of my heart."
        </div>

        <!-- Write Message Section -->
        <section class="write-section">
            <h2 class="section-title">Write a Message üíå</h2>
            <p style="text-align: center; margin-bottom: 30px; color: #666;">
                Write a sweet message. It will appear here instantly!
            </p>
            
            <div class="message-form">
                <div class="form-group">
                    <label class="form-label" for="message">Your Loving Message:</label>
                    <textarea class="message-input" id="message" 
                              placeholder="Type your sweetest message here... üíñ" 
                              rows="6"></textarea>
                </div>
                
                <button class="submit-btn" onclick="saveMessage()">
                    <i class="fas fa-paper-plane"></i> Send Message
                </button>
            </div>
        </section>

        <!-- Love Messages Display -->
        <section class="love-messages">
            <h2 class="section-title">Our Love Messages üíë</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">
                Every message is a heartbeat, every word is a kiss...
            </p>
            
            <!-- Loading Animation -->
            <div class="loader" id="loader">
                <div class="spinner"></div>
                <p>Loading love messages...</p>
            </div>
            
            <!-- Messages Container -->
            <div class="messages-container" id="messagesContainer">
                <!-- Messages will be loaded here -->
            </div>
        </section>

        <!-- Memories Section -->
        <section class="memories-section">
            <h2 class="section-title">Our Love Statistics üìä</h2>
            <div class="memory-stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">Love Messages</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayMessages">0</div>
                    <div class="stat-label">Messages Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="loveScore">100%</div>
                    <div class="stat-label">Love Meter</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="streakDays">0</div>
                    <div class="stat-label">Love Streak</div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <div class="heart-pulse">
                <i class="fas fa-heart footer-heart"></i>
            </div>
            <p>Made with <i class="fas fa-heart" style="color: #ff4081;"></i> by Someone who loves you infinitely</p>
            <p>Every moment with you is precious üíï</p>
            <p style="margin-top: 20px; font-size: 0.9rem; opacity: 0.8;">
                This page is the memories for us.
            </p>
        </footer>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i> Message sent successfully!
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD9I-bo9haCE3KXQbVDs2nzTFXKA4a5gdw",
            authDomain: "affu-ca49d.firebaseapp.com",
            databaseURL: "https://affu-ca49d-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "affu-ca49d",
            storageBucket: "affu-ca49d.firebasestorage.app",
            messagingSenderId: "974065384206",
            appId: "1:974065384206:web:da25af00ec8d375eddb55f",
            measurementId: "G-D7MZ5JLT6T"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const messagesContainer = document.getElementById('messagesContainer');
        const loader = document.getElementById('loader');
        const notification = document.getElementById('notification');
        const secretMessage = document.getElementById('secretMessage');
        const secretText = document.getElementById('secretText');
        const loveQuote = document.getElementById('loveQuote');
        const errorMessage = document.getElementById('errorMessage');

        // Music Elements
        const bgMusic = document.getElementById('bgMusic');
        const musicBtn = document.getElementById('musicBtn');
        const songTitle = document.getElementById('songTitle');

        // Music Variables
        const songs = [
            { title: "Duniya ‚ù§Ô∏è", src: "music/duniya.mp3" },
            { title: "Saiyara üíï", src: "music/saiyara.mp3" },
            { title: "Jaan ‚ú®", src: "music/jaan.mp3" }
        ];
        let currentSongIndex = 0;

        // Global Variables
        let messages = [];
        let loveStartDate = new Date('2024-06-04'); // 4 June 2024 - Our first meeting

        // Initialize Page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded. Initializing...');
            initializeMusic(); // Add this line
            createFloatingHearts();
            loadMessages();
            updateLoveTimer();
            showRandomQuote();
            setupRealTimeUpdates();
            
            // Start love timer
            setInterval(updateLoveTimer, 1000);
            
            // Show random secret messages
            setInterval(showRandomSecret, 10000); // Every 5 minutes
            
            // Change quote every 30 seconds
            setInterval(showRandomQuote, 5000);
        });

        // Initialize Music Player
        function initializeMusic() {
            if (songs.length > 0) {
                bgMusic.src = songs[currentSongIndex].src;
                songTitle.textContent = songs[currentSongIndex].title;
                
                // Auto play when song ends
                bgMusic.addEventListener('ended', function() {
                    nextSong();
                });
            }
        }

        // Toggle Music Play/Pause
        function toggleMusic() {
            if (bgMusic.paused) {
                bgMusic.play()
                    .then(() => {
                        musicBtn.innerHTML = '<i class="fas fa-pause"></i>';
                        musicBtn.style.color = '#4CAF50';
                        songTitle.style.color = '#4CAF50';
                    })
                    .catch(error => {
                        console.error('Error playing music:', error);
                        showNotification('Could not play music. Make sure music files are in "music" folder.', 'error');
                    });
            } else {
                bgMusic.pause();
                musicBtn.innerHTML = '<i class="fas fa-play"></i>';
                musicBtn.style.color = '#ff4081';
                songTitle.style.color = '#666';
            }
        }

        // Next Song
        function nextSong() {
            currentSongIndex = (currentSongIndex + 1) % songs.length;
            bgMusic.src = songs[currentSongIndex].src;
            songTitle.textContent = songs[currentSongIndex].title;
            
            if (!bgMusic.paused) {
                bgMusic.play()
                    .then(() => {
                        musicBtn.innerHTML = '<i class="fas fa-pause"></i>';
                        musicBtn.style.color = '#4CAF50';
                        songTitle.style.color = '#4CAF50';
                    });
            }
            
            showNotification(`Now playing: ${songs[currentSongIndex].title}`, 'music');
        }

        // Previous Song
        function previousSong() {
            currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
            bgMusic.src = songs[currentSongIndex].src;
            songTitle.textContent = songs[currentSongIndex].title;
            
            if (!bgMusic.paused) {
                bgMusic.play()
                    .then(() => {
                        musicBtn.innerHTML = '<i class="fas fa-pause"></i>';
                        musicBtn.style.color = '#4CAF50';
                        songTitle.style.color = '#4CAF50';
                    });
            }
            
            showNotification(`Now playing: ${songs[currentSongIndex].title}`, 'music');
        }

        // Create Floating Hearts
        function createFloatingHearts() {
            const heartsContainer = document.getElementById('heartsContainer');
            const heartCount = 50;
            
            for (let i = 0; i < heartCount; i++) {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.innerHTML = '‚ù§';
                heart.style.left = `${Math.random() * 100}%`;
                heart.style.animationDelay = `${Math.random() * 15}s`;
                heart.style.fontSize = `${Math.random() * 20 + 10}px`;
                heart.style.color = `rgba(255, ${Math.random() * 100 + 64}, ${Math.random() * 100 + 129}, ${Math.random() * 0.3 + 0.1})`;
                
                heartsContainer.appendChild(heart);
            }
        }

        // Load Messages from Firebase (FIXED VERSION)
        function loadMessages() {
            console.log('Loading messages from Firebase...');
            loader.style.display = 'block';
            messagesContainer.innerHTML = '';
            
            const messagesRef = database.ref('loveMessages');
            
            messagesRef.on('value', (snapshot) => {
                console.log('Firebase snapshot received:', snapshot.exists());
                messages = [];
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    console.log('Raw data from Firebase:', data);
                    
                    Object.keys(data).forEach(key => {
                        try {
                            const messageData = data[key];
                            
                            // Handle both old string format and new object format
                            let messageObj;
                            
                            if (typeof messageData === 'string') {
                                // Old format: direct string
                                console.warn(`Old string format detected for key ${key}`);
                                messageObj = {
                                    id: key,
                                    text: messageData,
                                    timestamp: Date.now(),
                                    date: new Date().toISOString()
                                };
                            } else if (typeof messageData === 'object' && messageData !== null) {
                                // New format: object with text and timestamp
                                messageObj = {
                                    id: key,
                                    text: messageData.text || 'No message text',
                                    timestamp: messageData.timestamp || Date.now(),
                                    date: messageData.date || new Date().toISOString()
                                };
                            } else {
                                // Invalid format
                                console.error(`Invalid format for key ${key}:`, messageData);
                                return;
                            }
                            
                            messages.push(messageObj);
                            
                        } catch (error) {
                            console.error(`Error processing message ${key}:`, error);
                        }
                    });
                    
                    console.log(`Total messages loaded: ${messages.length}`);
                    
                    // Sort by timestamp (newest first)
                    messages.sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Display messages
                    displayMessages();
                    
                    updateStats();
                    
                } else {
                    console.log('No messages found in database');
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; grid-column: 1/-1; padding: 40px;">
                            <div style="font-size: 4rem; color: #ff4081; margin-bottom: 20px;">
                                <i class="fas fa-heart-broken"></i>
                            </div>
                            <h3 style="color: #666;">No love messages yet</h3>
                            <p style="color: #888;">Be the first to write a sweet message! üíñ</p>
                        </div>
                    `;
                }
                
                loader.style.display = 'none';
            }, (error) => {
                console.error('Error loading messages:', error);
                showError('Error loading messages. Please refresh the page.');
                loader.style.display = 'none';
            });
        }

        // Display Messages
        function displayMessages() {
            messagesContainer.innerHTML = '';
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div style="text-align: center; grid-column: 1/-1; padding: 40px;">
                        <p style="color: #888;">No messages to display yet.</p>
                    </div>
                `;
                return;
            }
            
            messages.forEach(message => {
                const messageCard = createMessageCard(message);
                messagesContainer.appendChild(messageCard);
            });
        }

        // Create Message Card
        function createMessageCard(message) {
            const card = document.createElement('div');
            card.className = 'message-card';
            
            // Ensure timestamp is a number
            const timestamp = typeof message.timestamp === 'number' ? message.timestamp : Date.now();
            const date = new Date(timestamp);
            
            // Validate date
            let formattedDate;
            if (isNaN(date.getTime())) {
                formattedDate = 'Recent';
            } else {
                formattedDate = date.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            // Calculate time ago
            const timeAgo = getTimeAgo(timestamp);
            
            // Add special effects for recent messages
            const isRecent = Date.now() - timestamp < 300000; // 5 minutes
            
            if (isRecent) {
                card.style.animation = 'pulse 2s infinite';
            }
            
            card.innerHTML = `
                <div class="message-content">
                    <i class="fas fa-quote-left" style="color: #ff4081; opacity: 0.5; margin-right: 10px;"></i>
                    ${message.text}
                    <i class="fas fa-quote-right" style="color: #ff4081; opacity: 0.5; margin-left: 10px;"></i>
                </div>
                <div class="message-meta">
                    <span><i class="fas fa-clock love-icon"></i> ${timeAgo}</span>
                    <span><i class="fas fa-calendar love-icon"></i> ${formattedDate}</span>
                </div>
                ${isRecent ? '<div style="position: absolute; top: 10px; right: 10px; color: #ff4081; animation: pulse 1s infinite;"><i class="fas fa-bolt"></i> New!</div>' : ''}
            `;
            
            // Add click effect
            card.addEventListener('click', function() {
                this.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 200);
                
                // Show message in alert
                showMessagePopup(message.text);
            });
            
            return card;
        }

        // Get Time Ago
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            // Handle invalid timestamps
            if (isNaN(diff) || diff < 0) {
                return 'Recently';
            }
            
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
            if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            if (seconds > 30) return `${seconds} second${seconds > 1 ? 's' : ''} ago`;
            return 'Just now';
        }

        // Save Message to Firebase
        function saveMessage() {
            const messageInput = document.getElementById('message');
            const messageText = messageInput.value.trim();
            
            if (!messageText) {
                showNotification('Please write a message first!', 'error');
                messageInput.focus();
                return;
            }
            
            if (messageText.length > 1000) {
                showNotification('Message is too long! Keep it under 1000 characters.', 'error');
                return;
            }
            
            const messageData = {
                text: messageText,
                timestamp: Date.now(),
                date: new Date().toISOString()
            };
            
            console.log('Saving message:', messageData);
            
            // Save to Firebase
            const newMessageRef = database.ref('loveMessages').push();
            newMessageRef.set(messageData)
                .then(() => {
                    showNotification('üíñ Love message sent successfully!');
                    messageInput.value = '';
                    
                    // Update stats
                    updateStats();
                })
                .catch(error => {
                    console.error('Error saving message:', error);
                    showNotification('Failed to send message. Please try again.', 'error');
                });
        }

        // Show Notification
        function showNotification(text, type = 'success') {
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'music' ? 'music' : 'exclamation-circle'}"></i> ${text}
            `;
            
            if (type === 'success') {
                notification.style.background = 'linear-gradient(45deg, #4CAF50, #45a049)';
            } else if (type === 'music') {
                notification.style.background = 'linear-gradient(45deg, #2196F3, #1976D2)';
            } else {
                notification.style.background = 'linear-gradient(45deg, #f44336, #d32f2f)';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Show Error Message
        function showError(text) {
            errorMessage.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i> ${text}
            `;
            errorMessage.style.display = 'block';
            
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        // Show Message Popup
        function showMessagePopup(text) {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 40px;
                border-radius: 20px;
                max-width: 500px;
                text-align: center;
                position: relative;
                animation: popup 0.3s ease;
            `;
            
            content.innerHTML = `
                <button onclick="this.parentElement.parentElement.remove()" 
                        style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5rem; color: #ff4081; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
                <div style="font-size: 3rem; color: #ff4081; margin-bottom: 20px;">
                    <i class="fas fa-heart"></i>
                </div>
                <h3 style="color: #333; margin-bottom: 20px;">Love Message üíå</h3>
                <p style="color: #555; font-size: 1.1rem; line-height: 1.6;">${text}</p>
                <div style="margin-top: 30px; color: #888; font-size: 0.9rem;">
                    <i class="fas fa-heart" style="color: #ff4081;"></i> Double-click anywhere to close
                </div>
            `;
            
            popup.appendChild(content);
            document.body.appendChild(popup);
            
            popup.addEventListener('dblclick', () => popup.remove());
            
            // Add CSS for animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes popup {
                    from { opacity: 0; transform: scale(0.8); }
                    to { opacity: 1; transform: scale(1); }
                }
            `;
            document.head.appendChild(style);
        }

        // Update Love Timer
        function updateLoveTimer() {
            const now = new Date();
            const diff = now - loveStartDate;
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            document.getElementById('loveTimer').textContent = 
                `${days} days, ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Show Random Secret Message
        function showRandomSecret() {
            const secrets = [
                "You're more beautiful than any sunset I've ever seen.",
                "My heart skips a beat every time I think of you.",
                "You're the best thing that ever happened to me.",
                "I fall in love with you more every single day.",
                "Your smile is my favorite thing in the world.",
                "I dream of you even when I'm awake.",
                "You complete me in ways I never knew possible.",
                "My love for you grows stronger with every passing moment.",
                "You're the reason I believe in forever.",
                "Every love song reminds me of you."
            ];
            
            const randomSecret = secrets[Math.floor(Math.random() * secrets.length)];
            secretText.textContent = randomSecret;
            secretMessage.style.display = 'block';
            
            // Auto hide after 10 seconds
            setTimeout(() => {
                secretMessage.style.display = 'none';
            }, 10000);
        }

        // Show Random Love Quote
        function showRandomQuote() {
            const quotes = [
                "You are the source of my joy, the center of my world, and the whole of my heart.",
                "In your arms is where I belong, in your heart is what I desire, in your eyes is all I see.",
                "I saw that you were perfect, and so I loved you. Then I saw that you were not perfect and I loved you even more.",
                "If I had a flower for every time I thought of you, I could walk in my garden forever.",
                "I love you not only for what you are, but for what I am when I am with you.",
                "You're the first thing I think of when I wake up, and the last thing I think of before I sleep.",
                "My love for you is a journey; starting at forever and ending at never.",
                "I never want to stop making memories with you.",
                "You are my today and all of my tomorrows.",
                "I love you more than I have ever found a way to say to you."
            ];
            
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            loveQuote.textContent = `"${randomQuote}"`;
            
            // Add fade effect
            loveQuote.style.opacity = '0';
            setTimeout(() => {
                loveQuote.style.transition = 'opacity 0.5s ease';
                loveQuote.style.opacity = '1';
            }, 10);
        }

        // Update Statistics (FIXED VERSION)
        function updateStats() {
            console.log('Updating statistics...');
            
            const totalMessages = messages.length;
            console.log(`Total messages: ${totalMessages}`);
            
            // Get today's date properly
            const today = new Date();
            const todayString = today.toDateString();
            console.log(`Today's date: ${todayString}`);
            
            // Filter today's messages with proper date comparison
            const todayMessages = messages.filter(msg => {
                try {
                    // Ensure timestamp is a number
                    const msgTimestamp = typeof msg.timestamp === 'number' ? msg.timestamp : Date.now();
                    const msgDate = new Date(msgTimestamp);
                    
                    // Check if date is valid
                    if (isNaN(msgDate.getTime())) {
                        return false;
                    }
                    
                    return msgDate.toDateString() === todayString;
                } catch (error) {
                    console.error('Error filtering message:', error);
                    return false;
                }
            }).length;
            
            console.log(`Today's messages: ${todayMessages}`);
            
            // Calculate love score
            const loveScore = Math.min(100, Math.floor((totalMessages / 10) * 100));
            
            // Calculate streak
            const uniqueDates = [];
            messages.forEach(msg => {
                try {
                    const msgTimestamp = typeof msg.timestamp === 'number' ? msg.timestamp : Date.now();
                    const msgDate = new Date(msgTimestamp);
                    
                    if (!isNaN(msgDate.getTime())) {
                        const dateString = msgDate.toDateString();
                        if (!uniqueDates.includes(dateString)) {
                            uniqueDates.push(dateString);
                        }
                    }
                } catch (error) {
                    console.error('Error processing message for streak:', error);
                }
            });
            
            const streakDays = uniqueDates.length;
            
            // Update UI with safe values
            document.getElementById('totalMessages').textContent = totalMessages;
            document.getElementById('todayMessages').textContent = Math.max(0, todayMessages);
            document.getElementById('loveScore').textContent = `${Math.max(0, loveScore)}%`;
            document.getElementById('streakDays').textContent = Math.max(0, streakDays);
            
            // Animate number changes only if values are valid
            if (totalMessages >= 0) {
                animateCounter('totalMessages', totalMessages);
            }
            if (todayMessages >= 0) {
                animateCounter('todayMessages', todayMessages);
            }
        }

        // Animate Counter
        function animateCounter(elementId, finalValue) {
            const element = document.getElementById(elementId);
            const currentText = element.textContent;
            
            // Extract current number (remove % if present)
            let current = 0;
            if (currentText.includes('%')) {
                current = parseInt(currentText.replace('%', '')) || 0;
            } else {
                current = parseInt(currentText) || 0;
            }
            
            // Ensure finalValue is a number
            finalValue = parseInt(finalValue) || 0;
            
            // Don't animate if values are same or invalid
            if (current === finalValue || finalValue < 0) {
                element.textContent = elementId === 'loveScore' ? `${finalValue}%` : finalValue;
                return;
            }
            
            const increment = finalValue > current ? 1 : -1;
            
            let currentValue = current;
            const interval = setInterval(() => {
                currentValue += increment;
                
                // Update display
                if (elementId === 'loveScore') {
                    element.textContent = `${currentValue}%`;
                } else {
                    element.textContent = currentValue;
                }
                
                // Stop when reached target
                if ((increment > 0 && currentValue >= finalValue) || 
                    (increment < 0 && currentValue <= finalValue)) {
                    clearInterval(interval);
                    
                    // Set final value exactly
                    if (elementId === 'loveScore') {
                        element.textContent = `${finalValue}%`;
                    } else {
                        element.textContent = finalValue;
                    }
                }
            }, 20);
        }

        // Setup Real-time Updates
        function setupRealTimeUpdates() {
            const messagesRef = database.ref('loveMessages');
            
            messagesRef.on('child_added', (snapshot) => {
                console.log('New message added!');
                updateStats();
                
                // Show notification for new messages
                showNotification('üíï New love message received!', 'success');
            });
        }

        // Add some interactive effects
        document.addEventListener('click', function(e) {
            // Create heart on click
            if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'TEXTAREA') {
                createClickHeart(e.clientX, e.clientY);
            }
        });

        function createClickHeart(x, y) {
            const heart = document.createElement('div');
            heart.innerHTML = '‚ù§';
            heart.style.cssText = `
                position: fixed;
                left: ${x - 15}px;
                top: ${y - 15}px;
                font-size: 30px;
                color: #ff4081;
                pointer-events: none;
                z-index: 1000;
                animation: floatUpFast 1s ease-out forwards;
            `;
            
            document.body.appendChild(heart);
            
            setTimeout(() => {
                heart.remove();
            }, 1000);
            
            // Add CSS for animation
            const style = document.createElement('style');
            if (!document.querySelector('#clickHeartStyle')) {
                style.id = 'clickHeartStyle';
                style.textContent = `
                    @keyframes floatUpFast {
                        0% { opacity: 1; transform: translateY(0) scale(1); }
                        100% { opacity: 0; transform: translateY(-100px) scale(0.5); }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Add keyboard shortcut (Ctrl+Enter to send message)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                saveMessage();
            }
        });

        // Add page load animation
        window.addEventListener('load', function() {
            document.body.style.opacity = '0';
            document.body.style.transition = 'opacity 1s ease';
            
            setTimeout(() => {
                document.body.style.opacity = '1';
            }, 100);
        });
        
        // Debug function to check database
        function debugDatabase() {
            console.log('=== DEBUG DATABASE ===');
            const messagesRef = database.ref('loveMessages');
            
            messagesRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    console.log('Total keys:', Object.keys(data).length);
                    
                    Object.keys(data).forEach((key, index) => {
                        console.log(`\nMessage ${index + 1}:`);
                        console.log('Key:', key);
                        console.log('Value:', data[key]);
                        console.log('Type:', typeof data[key]);
                        
                        if (typeof data[key] === 'object') {
                            console.log('Properties:', Object.keys(data[key]));
                        }
                    });
                } else {
                    console.log('No data in database');
                }
            });
        }
    </script>
</body>
</html>
